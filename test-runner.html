<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾·å›½ç‹¬ç«‹å‚¨èƒ½ç”µç«™è´¢åŠ¡æ¨¡å‹ - æµ‹è¯•æŠ¥å‘Š</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-green: #00d4aa;
            --accent-red: #ef4444;
            --accent-yellow: #fbbf24;
            --accent-blue: #3b82f6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 40px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--accent-green);
        }
        
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .summary-card {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--bg-tertiary);
        }
        
        .summary-card .number {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .summary-card .label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .summary-card.total .number { color: var(--text-primary); }
        .summary-card.passed .number { color: var(--accent-green); }
        .summary-card.failed .number { color: var(--accent-red); }
        .summary-card.rate .number { color: var(--accent-blue); }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
            border-radius: 6px;
            transition: width 0.5s ease;
        }
        
        .test-suite {
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid var(--bg-tertiary);
        }
        
        .suite-header {
            padding: 20px 25px;
            background: var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .suite-header:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .suite-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .suite-stats {
            display: flex;
            gap: 15px;
        }
        
        .suite-stat {
            font-size: 0.9rem;
            padding: 4px 12px;
            border-radius: 20px;
        }
        
        .suite-stat.passed {
            background: rgba(0, 212, 170, 0.2);
            color: var(--accent-green);
        }
        
        .suite-stat.failed {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }
        
        .test-cases {
            padding: 15px 25px;
        }
        
        .test-case {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: var(--bg-primary);
        }
        
        .test-case:last-child {
            margin-bottom: 0;
        }
        
        .test-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 14px;
        }
        
        .test-case.passed .test-icon {
            background: var(--accent-green);
            color: var(--bg-primary);
        }
        
        .test-case.failed .test-icon {
            background: var(--accent-red);
            color: white;
        }
        
        .test-name {
            flex: 1;
            font-size: 0.95rem;
        }
        
        .test-duration {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-left: 15px;
        }
        
        .test-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-left: 39px;
            margin-top: 5px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }
        
        .test-details.error {
            color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .test-details code {
            font-family: 'Consolas', 'Courier New', monospace;
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        .timestamp {
            font-size: 0.9rem;
        }
        
        .run-button {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border: none;
            color: white;
            padding: 15px 40px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .run-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 212, 170, 0.3);
        }
        
        .run-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .test-suite {
            animation: fadeIn 0.3s ease forwards;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”‹ å¾·å›½ç‹¬ç«‹å‚¨èƒ½ç”µç«™è´¢åŠ¡æ¨¡å‹</h1>
        <div class="subtitle">è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š - è½¯ä»¶æµ‹è¯•å·¥ç¨‹å¸ˆ</div>
    </div>
    
    <button class="run-button" id="runTestsBtn" onclick="runAllTests()">â–¶ è¿è¡Œæµ‹è¯•</button>
    
    <div id="testResults">
        <div class="loading" id="loadingIndicator" style="display: none;">
            <div class="spinner"></div>
            <p>æ­£åœ¨æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹...</p>
        </div>
    </div>
    
    <div class="footer">
        <p class="timestamp" id="timestamp"></p>
        <p style="margin-top: 10px;">æµ‹è¯•æ¡†æ¶ç‰ˆæœ¬: 1.0.0 | è¦†ç›–æ ¸å¿ƒè®¡ç®—æ¨¡å—</p>
    </div>

    <!-- å¼•å…¥è´¢åŠ¡æ¨¡å‹æ ¸å¿ƒä»£ç  -->
    <script src="financial-model.js"></script>
    
    <!-- æµ‹è¯•æ¡†æ¶å’Œæµ‹è¯•ç”¨ä¾‹ -->
    <script>
        /**
         * ç®€æ˜“æµ‹è¯•æ¡†æ¶
         * @description ç”¨äºæµ‹è¯•å¾·å›½ç‹¬ç«‹å‚¨èƒ½ç”µç«™è´¢åŠ¡æ¨¡å‹
         */
        class TestFramework {
            constructor() {
                this.suites = [];
                this.currentSuite = null;
                this.totalTests = 0;
                this.passedTests = 0;
                this.failedTests = 0;
            }
            
            /**
             * å®šä¹‰æµ‹è¯•å¥—ä»¶
             * @param {string} name å¥—ä»¶åç§°
             * @param {Function} fn æµ‹è¯•å‡½æ•°
             */
            describe(name, fn) {
                this.currentSuite = {
                    name: name,
                    tests: [],
                    passed: 0,
                    failed: 0
                };
                fn();
                this.suites.push(this.currentSuite);
                this.currentSuite = null;
            }
            
            /**
             * å®šä¹‰æµ‹è¯•ç”¨ä¾‹
             * @param {string} name ç”¨ä¾‹åç§°
             * @param {Function} fn æµ‹è¯•å‡½æ•°
             */
            it(name, fn) {
                const test = {
                    name: name,
                    passed: false,
                    error: null,
                    details: null,
                    duration: 0
                };
                
                const start = performance.now();
                try {
                    fn();
                    test.passed = true;
                    this.currentSuite.passed++;
                    this.passedTests++;
                } catch (e) {
                    test.passed = false;
                    test.error = e.message;
                    this.currentSuite.failed++;
                    this.failedTests++;
                }
                test.duration = (performance.now() - start).toFixed(2);
                
                this.currentSuite.tests.push(test);
                this.totalTests++;
            }
            
            /**
             * æ–­è¨€ç›¸ç­‰
             */
            assertEqual(actual, expected, message = '') {
                if (actual !== expected) {
                    throw new Error(`${message} é¢„æœŸ: ${expected}, å®é™…: ${actual}`);
                }
            }
            
            /**
             * æ–­è¨€è¿‘ä¼¼ç›¸ç­‰ï¼ˆç”¨äºæµ®ç‚¹æ•°ï¼‰
             */
            assertAlmostEqual(actual, expected, tolerance = 0.01, message = '') {
                if (Math.abs(actual - expected) > tolerance) {
                    throw new Error(`${message} é¢„æœŸ: ${expected}Â±${tolerance}, å®é™…: ${actual}`);
                }
            }
            
            /**
             * æ–­è¨€ä¸ºçœŸ
             */
            assertTrue(condition, message = '') {
                if (!condition) {
                    throw new Error(message || 'æ–­è¨€å¤±è´¥ï¼šæ¡ä»¶åº”ä¸ºçœŸ');
                }
            }
            
            /**
             * æ–­è¨€ä¸ºå‡
             */
            assertFalse(condition, message = '') {
                if (condition) {
                    throw new Error(message || 'æ–­è¨€å¤±è´¥ï¼šæ¡ä»¶åº”ä¸ºå‡');
                }
            }
            
            /**
             * æ–­è¨€ä¸ä¸ºç©º/undefined
             */
            assertNotNull(value, message = '') {
                if (value === null || value === undefined) {
                    throw new Error(message || 'æ–­è¨€å¤±è´¥ï¼šå€¼ä¸åº”ä¸ºç©º');
                }
            }
            
            /**
             * æ–­è¨€ä¸ºæ•°å­—
             */
            assertIsNumber(value, message = '') {
                if (typeof value !== 'number' || isNaN(value)) {
                    throw new Error(message || `æ–­è¨€å¤±è´¥ï¼š${value} åº”ä¸ºæœ‰æ•ˆæ•°å­—`);
                }
            }
            
            /**
             * æ–­è¨€å¤§äº
             */
            assertGreaterThan(actual, expected, message = '') {
                if (actual <= expected) {
                    throw new Error(`${message} ${actual} åº”å¤§äº ${expected}`);
                }
            }
            
            /**
             * æ–­è¨€å°äº
             */
            assertLessThan(actual, expected, message = '') {
                if (actual >= expected) {
                    throw new Error(`${message} ${actual} åº”å°äº ${expected}`);
                }
            }
            
            /**
             * æ–­è¨€åœ¨èŒƒå›´å†…
             */
            assertInRange(actual, min, max, message = '') {
                if (actual < min || actual > max) {
                    throw new Error(`${message} ${actual} åº”åœ¨ [${min}, ${max}] èŒƒå›´å†…`);
                }
            }
            
            /**
             * æ¸²æŸ“æµ‹è¯•ç»“æœ
             */
            renderResults() {
                const container = document.getElementById('testResults');
                const passRate = this.totalTests > 0 ? 
                    ((this.passedTests / this.totalTests) * 100).toFixed(1) : 0;
                
                let html = `
                    <div class="summary">
                        <div class="summary-card total">
                            <div class="number">${this.totalTests}</div>
                            <div class="label">æµ‹è¯•ç”¨ä¾‹æ€»æ•°</div>
                        </div>
                        <div class="summary-card passed">
                            <div class="number">${this.passedTests}</div>
                            <div class="label">é€šè¿‡</div>
                        </div>
                        <div class="summary-card failed">
                            <div class="number">${this.failedTests}</div>
                            <div class="label">å¤±è´¥</div>
                        </div>
                        <div class="summary-card rate">
                            <div class="number">${passRate}%</div>
                            <div class="label">é€šè¿‡ç‡</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${passRate}%"></div>
                    </div>
                `;
                
                this.suites.forEach((suite, index) => {
                    html += `
                        <div class="test-suite" style="animation-delay: ${index * 0.1}s">
                            <div class="suite-header">
                                <span class="suite-title">${suite.name}</span>
                                <div class="suite-stats">
                                    <span class="suite-stat passed">âœ“ ${suite.passed}</span>
                                    ${suite.failed > 0 ? `<span class="suite-stat failed">âœ— ${suite.failed}</span>` : ''}
                                </div>
                            </div>
                            <div class="test-cases">
                    `;
                    
                    suite.tests.forEach(test => {
                        html += `
                            <div class="test-case ${test.passed ? 'passed' : 'failed'}">
                                <div class="test-icon">${test.passed ? 'âœ“' : 'âœ—'}</div>
                                <span class="test-name">${test.name}</span>
                                <span class="test-duration">${test.duration}ms</span>
                            </div>
                        `;
                        if (test.error) {
                            html += `<div class="test-details error">âŒ ${test.error}</div>`;
                        }
                    });
                    
                    html += `</div></div>`;
                });
                
                container.innerHTML = html;
                
                document.getElementById('timestamp').textContent = 
                    `æµ‹è¯•æ‰§è¡Œæ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
            }
        }
        
        // åˆ›å»ºæµ‹è¯•å®ä¾‹
        const test = new TestFramework();
        
        /**
         * è·å–æµ‹è¯•ç”¨çš„é»˜è®¤å‚æ•°
         * @returns {Object} é»˜è®¤å‚æ•°å¯¹è±¡
         */
        function getTestParameters() {
            return {
                // åŸºç¡€å‚æ•°
                power_mw: 100,
                capacity_mwh: 200,
                operation_years: 20,
                initial_capacity_pct: 100,
                
                // èèµ„å‚æ•°
                equity_ratio: 0.25,
                loan_years: 12,
                loan_rate: 0.045,
                grace_period: 1,
                repayment_method: 'equal_principal',
                // å»ºè®¾æœŸä¸é€šèƒ€å‚æ•°
                construction_period: 1,
                construction_fund_usage: 0.5,
                inflation_rate: 0.02,
                
                // æŠ˜æ—§å‚æ•°
                depreciation_years: 15,
                salvage_rate: 0.05,
                depreciation_method: 'straight_line',
                amortization_years: 20,
                
                // æ•ˆç‡å‚æ•°
                charge_efficiency: 0.95,
                discharge_efficiency: 0.95,
                degradation_rate: 0.025,
                annual_cycles: 365,
                
                // ç¨è´¹å‚æ•°
                corporate_tax_rate: 0.15,
                solidarity_tax_rate: 0.055,
                trade_tax_rate: 0.14,
                vat_rate: 0.19,
                other_tax_rate: 0,
                
                // Tollingå‚æ•°
                tolling_years: 10,
                tolling_ratio: 0.8,
                tolling_price: 75,
                tolling_escalation: 0.02,
                
                // ä¸»è®¾å¤‡å‚æ•°
                battery_cabinet_capacity: 5.0,
                battery_cabinet_count: 40,
                battery_unit_price: 85,
                pcs_power: 5.5,
                pcs_count: 19,
                pcs_unit_price: 28,
                mv_transformer_capacity: 6300,
                mv_transformer_count: 19,
                mv_transformer_price: 35000,
                hv_transformer_capacity: 120,
                hv_transformer_count: 1,
                hv_transformer_price: 750000,
                
                // è¾…åŠ©è®¾å¤‡å‚æ•°
                ems_cost: 200000,
                scada_cost: 120000,
                switchgear_price: 18000,
                switchgear_count: 25,
                collector_line_cost: 250000,
                thermal_cost: 20,
                fire_protection_cost: 12,
                
                // ç”µç½‘æ¥å…¥å‚æ•°
                substation_cost: 800000,
                grid_line_cost: 500000,
                grid_study_cost: 80000,
                metering_cost: 100000,
                
                // åœŸåœ°ä¸åŸºå»ºå‚æ•°
                land_acquisition_cost: 50,
                concrete_cost: 25,
                fence_cost: 80000,
                road_cost: 120000,
                drainage_cost: 50000,
                
                // å®‰è£…ä¸æ–½å·¥å‚æ•°
                installation_cost_pct: 0.06,
                construction_mgmt_pct: 0.025,
                commissioning_cost: 150000,
                
                // å»ºè®¾æœŸä¿é™©å‚æ•°
                car_insurance_pct: 0.003,
                ear_insurance_pct: 0.002,
                cargo_insurance_pct: 0.0015,
                liability_insurance: 50000,
                
                // å¼€å‘ä¸ä¸šä¸»è´¹ç”¨å‚æ•°
                spv_acquisition_cost: 50000,
                permit_cost: 180000,
                environmental_cost: 60000,
                project_mgmt_pct: 0.02,
                legal_cost: 100000,
                engineering_pct: 0.025,
                contingency_pct: 0.05,
                
                // æ‹†é™¤å‡†å¤‡é‡‘ï¼ˆæŒ‰å¹´æ‘Šé”€ï¼‰
                decommissioning_total: 500000,
                
                // OPEXå‚æ•°
                opex_technical: 6,
                opex_technical_esc: 0.02,
                opex_insurance: 0.004,
                opex_insurance_esc: 0.015,
                opex_grid: 12000,
                opex_grid_esc: 0.02,
                opex_land: 60000,
                opex_land_esc: 0.02,
                opex_commercial: 4000,
                opex_commercial_esc: 0.02,
                opex_other: 1500,
                opex_other_esc: 0.02
            };
        }
        
        /**
         * è¿è¡Œæ‰€æœ‰æµ‹è¯•
         */
        function runAllTests() {
            const btn = document.getElementById('runTestsBtn');
            const loading = document.getElementById('loadingIndicator');
            
            btn.disabled = true;
            loading.style.display = 'block';
            
            // é‡ç½®æµ‹è¯•æ¡†æ¶
            test.suites = [];
            test.totalTests = 0;
            test.passedTests = 0;
            test.failedTests = 0;
            
            setTimeout(() => {
                try {
                    // ========== 1. æ ¼å¼åŒ–å‡½æ•°æµ‹è¯• ==========
                    test.describe('1. æ ¼å¼åŒ–å‡½æ•°æµ‹è¯•', () => {
                        test.it('formatNumber - æ­£å¸¸æ•°å­—æ ¼å¼åŒ–', () => {
                            const result = formatNumber(12345.678);
                            test.assertTrue(result.includes('12') && result.includes('345'), 
                                'formatNumberåº”æ­£ç¡®æ ¼å¼åŒ–æ•°å­—');
                        });
                        
                        test.it('formatNumber - nullå€¼å¤„ç†', () => {
                            const result = formatNumber(null);
                            test.assertEqual(result, '-', 'nullå€¼åº”è¿”å›"-"');
                        });
                        
                        test.it('formatNumber - undefinedå€¼å¤„ç†', () => {
                            const result = formatNumber(undefined);
                            test.assertEqual(result, '-', 'undefinedå€¼åº”è¿”å›"-"');
                        });
                        
                        test.it('formatNumber - NaNå€¼å¤„ç†', () => {
                            const result = formatNumber(NaN);
                            test.assertEqual(result, '-', 'NaNå€¼åº”è¿”å›"-"');
                        });
                        
                        test.it('formatInt - æ•´æ•°æ ¼å¼åŒ–', () => {
                            const result = formatInt(12345.67);
                            test.assertTrue(result.includes('12') && result.includes('346'),
                                'formatIntåº”å››èˆäº”å…¥å¹¶æ ¼å¼åŒ–');
                        });
                        
                        test.it('formatPercent - ç™¾åˆ†æ¯”æ ¼å¼åŒ–', () => {
                            const result = formatPercent(15.5);
                            test.assertTrue(result.includes('15') && result.includes('5'),
                                'formatPercentåº”æ­£ç¡®æ ¼å¼åŒ–ç™¾åˆ†æ¯”');
                        });
                    });
                    
                    // ========== 2. CAPEXè®¡ç®—æµ‹è¯• ==========
                    test.describe('2. CAPEXè®¡ç®—æµ‹è¯•', () => {
                        const params = getTestParameters();
                        const capex = calculateCapex(params);
                        
                        test.it('ç”µæ± ç³»ç»Ÿæˆæœ¬è®¡ç®—æ­£ç¡®', () => {
                            // 200MWh * 1000 * 85EUR/kWh / 10000 = 1700ä¸‡EUR
                            const expected = params.capacity_mwh * 1000 * params.battery_unit_price / 10000;
                            test.assertAlmostEqual(capex.battery, expected, 0.1, 'ç”µæ± æˆæœ¬');
                        });
                        
                        test.it('PCSç³»ç»Ÿæˆæœ¬è®¡ç®—æ­£ç¡®', () => {
                            // 100MW * 1000 * 28EUR/kW / 10000 = 280ä¸‡EUR
                            const expected = params.power_mw * 1000 * params.pcs_unit_price / 10000;
                            test.assertAlmostEqual(capex.pcs, expected, 0.1, 'PCSæˆæœ¬');
                        });
                        
                        test.it('ä¸­å‹å˜å‹å™¨æˆæœ¬è®¡ç®—æ­£ç¡®', () => {
                            const expected = params.mv_transformer_count * params.mv_transformer_price / 10000;
                            test.assertAlmostEqual(capex.mv_transformer, expected, 0.1, 'ä¸­å‹å˜æˆæœ¬');
                        });
                        
                        test.it('å‡å‹å˜å‹å™¨æˆæœ¬è®¡ç®—æ­£ç¡®', () => {
                            const expected = params.hv_transformer_count * params.hv_transformer_price / 10000;
                            test.assertAlmostEqual(capex.hv_transformer, expected, 0.1, 'å‡å‹å˜æˆæœ¬');
                        });
                        
                        test.it('æ€»æŠ•èµ„å¤§äºé›¶', () => {
                            test.assertGreaterThan(capex.total, 0, 'CAPEXæ€»æŠ•èµ„');
                        });
                        
                        test.it('åŠ¨æ€æŠ•èµ„å¤§äºé™æ€æŠ•èµ„', () => {
                            test.assertGreaterThan(capex.dynamic_total, capex.total, 
                                'åŠ¨æ€æŠ•èµ„åº”å¤§äºé™æ€æŠ•èµ„ï¼ˆå«å»ºè®¾æœŸåˆ©æ¯ï¼‰');
                        });
                        
                        test.it('è®¾å¤‡è´¹å°è®¡ç­‰äºå„é¡¹è®¾å¤‡ä¹‹å’Œ', () => {
                            const sum = capex.battery + capex.pcs + capex.mv_transformer + 
                                       capex.hv_transformer + capex.ems + capex.scada + 
                                       capex.switchgear + capex.collector_line + 
                                       capex.thermal + capex.fire_protection;
                            test.assertAlmostEqual(capex.equipment_subtotal, sum, 0.1, 'è®¾å¤‡è´¹å°è®¡');
                        });
                        
                        test.it('ç”µç½‘æ¥å…¥è´¹å°è®¡æ­£ç¡®', () => {
                            const sum = capex.substation + capex.grid_line + 
                                       capex.grid_study + capex.metering;
                            test.assertAlmostEqual(capex.grid_connection_subtotal, sum, 0.1, 'ç”µç½‘æ¥å…¥å°è®¡');
                        });
                        
                        test.it('æŠ•èµ„æ€»é¢åœ¨åˆç†èŒƒå›´å†… (1000-10000ä¸‡EUR)', () => {
                            test.assertInRange(capex.total, 1000, 10000, 'CAPEXæ€»é¢');
                        });
                    });
                    
                    // ========== 3. OPEXè®¡ç®—æµ‹è¯• ==========
                    test.describe('3. OPEXè®¡ç®—æµ‹è¯•', () => {
                        const params = getTestParameters();
                        const capex = calculateCapex(params);
                        const opexData = calculateOpex(params, capex);
                        
                        test.it('è¿”å›æ­£ç¡®å¹´æ•°çš„OPEXæ•°æ®', () => {
                            test.assertEqual(opexData.length, params.operation_years, 'OPEXæ•°æ®å¹´æ•°');
                        });
                        
                        test.it('ç¬¬ä¸€å¹´OPEXå„é¡¹å¤§äºé›¶', () => {
                            test.assertGreaterThan(opexData[0].technical, 0, 'æŠ€æœ¯è¿ç»´è´¹');
                            test.assertGreaterThan(opexData[0].insurance, 0, 'ä¿é™©è´¹');
                            test.assertGreaterThan(opexData[0].grid, 0, 'ç”µç½‘è´¹ç”¨');
                        });
                        
                        test.it('OPEXå¹´åº¦é€’å¢ï¼ˆé€šèƒ€å› ç´ ï¼‰', () => {
                            test.assertGreaterThan(opexData[1].total, opexData[0].total, 
                                'ç¬¬äºŒå¹´OPEXåº”å¤§äºç¬¬ä¸€å¹´');
                        });
                        
                        test.it('æ¯å¹´OPEXæ€»è®¡ç­‰äºå„é¡¹ä¹‹å’Œ', () => {
                            const year1 = opexData[0];
                            const sum = year1.technical + year1.insurance + year1.grid + 
                                       year1.land + year1.commercial + year1.other;
                            test.assertAlmostEqual(year1.total, sum, 0.01, 'ç¬¬ä¸€å¹´OPEXæ€»è®¡');
                        });
                        
                        test.it('OPEXå¹´å‡å€¼åœ¨åˆç†èŒƒå›´ (50-500ä¸‡EUR)', () => {
                            const avgOpex = opexData.reduce((a, b) => a + b.total, 0) / opexData.length;
                            test.assertInRange(avgOpex, 50, 500, 'OPEXå¹´å‡å€¼');
                        });

                        test.it('æ‹†é™¤å‡†å¤‡é‡‘æŒ‰å¹´æ‘Šé”€è®¡å…¥OPEX', () => {
                            const expected = params.decommissioning_total / params.operation_years / 10000;
                            test.assertAlmostEqual(opexData[0].decommissioning, expected, 0.01, 'æ‹†é™¤å‡†å¤‡é‡‘å¹´æ‘Šé”€');
                        });
                    });
                    
                    // ========== 4. æ”¶å…¥è®¡ç®—æµ‹è¯• ==========
                    test.describe('4. æ”¶å…¥è®¡ç®—æµ‹è¯•', () => {
                        const params = getTestParameters();
                        // åˆ›å»ºæµ‹è¯•ç”¨ç°è´§ä»·æ ¼
                        const spotPrices = [];
                        for (let i = 0; i < params.operation_years; i++) {
                            spotPrices.push(35000 * Math.pow(1.015, i));
                        }
                        const revenueData = calculateRevenueWithPrices(params, spotPrices);
                        
                        test.it('è¿”å›æ­£ç¡®å¹´æ•°çš„æ”¶å…¥æ•°æ®', () => {
                            test.assertEqual(revenueData.length, params.operation_years, 'æ”¶å…¥æ•°æ®å¹´æ•°');
                        });
                        
                        test.it('TollingæœŸå†…æœ‰Tollingæ”¶å…¥', () => {
                            test.assertGreaterThan(revenueData[0].tollingRevenue, 0, 
                                'TollingæœŸç¬¬ä¸€å¹´åº”æœ‰Tollingæ”¶å…¥');
                        });
                        
                        test.it('TollingæœŸåæ— Tollingæ”¶å…¥', () => {
                            if (revenueData.length > params.tolling_years) {
                                test.assertEqual(revenueData[params.tolling_years].tollingRevenue, 0, 
                                    'TollingæœŸåä¸åº”æœ‰Tollingæ”¶å…¥');
                            }
                        });
                        
                        test.it('å®¹é‡å› å­éšæ—¶é—´è¡°å‡', () => {
                            test.assertGreaterThan(revenueData[0].capacityFactor, 
                                                  revenueData[9].capacityFactor, 
                                                  'å®¹é‡å› å­åº”éšç”µæ± è¡°å‡è€Œé™ä½');
                        });
                        
                        test.it('å¹´æ”¶å…¥æ€»è®¡å¤§äºé›¶', () => {
                            revenueData.forEach((data, index) => {
                                test.assertGreaterThan(data.totalRevenue, 0, 
                                    `ç¬¬${index + 1}å¹´æ”¶å…¥åº”å¤§äºé›¶`);
                            });
                        });
                        
                        test.it('æ”¶å…¥ç»„æˆç­‰äºæ€»æ”¶å…¥', () => {
                            const year1 = revenueData[0];
                            test.assertAlmostEqual(year1.totalRevenue, 
                                year1.tollingRevenue + year1.spotRevenue, 0.01, 'æ”¶å…¥ç»„æˆ');
                        });
                    });
                    
                    // ========== 5. æŠ˜æ—§è®¡ç®—æµ‹è¯• ==========
                    test.describe('5. æŠ˜æ—§è®¡ç®—æµ‹è¯•', () => {
                        const params = getTestParameters();
                        const capex = calculateCapex(params);
                        const depreciation = calculateDepreciation(params, capex);
                        
                        test.it('è¿”å›æ­£ç¡®å¹´æ•°çš„æŠ˜æ—§æ•°æ®', () => {
                            test.assertEqual(depreciation.length, params.operation_years, 'æŠ˜æ—§æ•°æ®å¹´æ•°');
                        });
                        
                        test.it('æŠ˜æ—§æœŸå†…æœ‰æŠ˜æ—§', () => {
                            test.assertGreaterThan(depreciation[0].depreciation, 0, 'ç¬¬ä¸€å¹´åº”æœ‰æŠ˜æ—§');
                        });
                        
                        test.it('ç›´çº¿æ³•æŠ˜æ—§å„å¹´ç›¸ç­‰', () => {
                            if (params.depreciation_method === 'straight_line') {
                                test.assertAlmostEqual(depreciation[0].depreciation, 
                                    depreciation[1].depreciation, 0.01, 'ç›´çº¿æ³•æŠ˜æ—§åº”ç›¸ç­‰');
                            }
                        });
                        
                        test.it('æŠ˜æ—§å¹´é™åæŠ˜æ—§ä¸ºé›¶', () => {
                            if (depreciation.length > params.depreciation_years) {
                                test.assertEqual(depreciation[params.depreciation_years].depreciation, 0, 
                                    'æŠ˜æ—§å¹´é™åæŠ˜æ—§åº”ä¸ºé›¶');
                            }
                        });
                        
                        test.it('ç›´çº¿æ³•æŠ˜æ—§æ€»é¢ç­‰äºå¯æŠ˜æ—§é‡‘é¢', () => {
                            const totalDep = depreciation.slice(0, params.depreciation_years)
                                .reduce((a, b) => a + b.depreciation, 0);
                            const depreciableAmount = capex.total * (1 - params.salvage_rate);
                            test.assertAlmostEqual(totalDep, depreciableAmount, 1, 'æŠ˜æ—§æ€»é¢');
                        });
                    });
                    
                    // ========== 6. è´·æ¬¾è®¡ç®—æµ‹è¯• ==========
                    test.describe('6. è´·æ¬¾è®¡ç®—æµ‹è¯•', () => {
                        const params = getTestParameters();
                        const capex = calculateCapex(params);
                        const loanData = calculateLoan(params, capex);
                        
                        test.it('è¿”å›æ­£ç¡®å¹´æ•°çš„è´·æ¬¾æ•°æ®', () => {
                            test.assertEqual(loanData.length, params.operation_years, 'è´·æ¬¾æ•°æ®å¹´æ•°');
                        });
                        
                        test.it('åˆå§‹è´·æ¬¾ä½™é¢æ­£ç¡®', () => {
                            const expectedLoan = capex.dynamic_total * (1 - params.equity_ratio);
                            test.assertAlmostEqual(loanData[0].beginBalance, expectedLoan, 1, 'åˆå§‹è´·æ¬¾é¢');
                        });
                        
                        test.it('å®½é™æœŸå†…åªä»˜æ¯ä¸è¿˜æœ¬', () => {
                            if (params.grace_period >= 1) {
                                test.assertEqual(loanData[0].principal, 0, 'å®½é™æœŸå†…æœ¬é‡‘ä¸ºé›¶');
                                test.assertGreaterThan(loanData[0].interest, 0, 'å®½é™æœŸå†…åº”æœ‰åˆ©æ¯');
                            }
                        });
                        
                        test.it('åˆ©æ¯è®¡ç®—æ­£ç¡®', () => {
                            const expectedInterest = loanData[0].beginBalance * params.loan_rate;
                            test.assertAlmostEqual(loanData[0].interest, expectedInterest, 0.1, 'ç¬¬ä¸€å¹´åˆ©æ¯');
                        });
                        
                        test.it('è´·æ¬¾åˆ°æœŸåä½™é¢ä¸ºé›¶', () => {
                            test.assertEqual(loanData[params.loan_years - 1].endBalance, 0, 
                                'è´·æ¬¾åˆ°æœŸåä½™é¢åº”ä¸ºé›¶');
                        });
                        
                        test.it('æ¯æœŸè¿˜æ¬¾é¢ç­‰äºæœ¬é‡‘åŠ åˆ©æ¯', () => {
                            loanData.forEach((data, i) => {
                                test.assertAlmostEqual(data.payment, data.principal + data.interest, 
                                    0.01, `ç¬¬${i + 1}å¹´è¿˜æ¬¾é¢`);
                            });
                        });
                        
                        test.it('æœŸæœ«ä½™é¢ç­‰äºæœŸåˆä½™é¢å‡æœ¬é‡‘', () => {
                            loanData.forEach((data, i) => {
                                if (data.beginBalance > 0) {
                                    test.assertAlmostEqual(data.endBalance, 
                                        Math.max(0, data.beginBalance - data.principal), 0.01, 
                                        `ç¬¬${i + 1}å¹´æœŸæœ«ä½™é¢`);
                                }
                            });
                        });
                    });
                    
                    // ========== 7. åˆ©æ¶¦è¡¨è®¡ç®—æµ‹è¯• ==========
                    test.describe('7. åˆ©æ¶¦è¡¨è®¡ç®—æµ‹è¯•', () => {
                        const params = getTestParameters();
                        const capex = calculateCapex(params);
                        const opexData = calculateOpex(params, capex);
                        const spotPrices = [];
                        for (let i = 0; i < params.operation_years; i++) {
                            spotPrices.push(35000 * Math.pow(1.015, i));
                        }
                        const revenueData = calculateRevenueWithPrices(params, spotPrices);
                        const depreciation = calculateDepreciation(params, capex);
                        const loanData = calculateLoan(params, capex);
                        const incomeData = calculateIncomeStatement(params, revenueData, opexData, depreciation, loanData);
                        
                        test.it('è¿”å›æ­£ç¡®å¹´æ•°çš„åˆ©æ¶¦è¡¨æ•°æ®', () => {
                            test.assertEqual(incomeData.length, params.operation_years, 'åˆ©æ¶¦è¡¨æ•°æ®å¹´æ•°');
                        });
                        
                        test.it('æ¯›åˆ©æ¶¦ç­‰äºæ”¶å…¥å‡æˆæœ¬', () => {
                            const year1 = incomeData[0];
                            test.assertAlmostEqual(year1.grossProfit, year1.revenue - year1.opex, 
                                0.01, 'æ¯›åˆ©æ¶¦è®¡ç®—');
                        });
                        
                        test.it('EBITç­‰äºEBITDAå‡æŠ˜æ—§', () => {
                            const year1 = incomeData[0];
                            test.assertAlmostEqual(year1.ebit, year1.ebitda - year1.depreciation, 
                                0.01, 'EBITè®¡ç®—');
                        });
                        
                        test.it('EBTç­‰äºEBITå‡åˆ©æ¯', () => {
                            const year1 = incomeData[0];
                            test.assertAlmostEqual(year1.ebt, year1.ebit - year1.interest, 
                                0.01, 'EBTè®¡ç®—');
                        });
                        
                        test.it('å‡€åˆ©æ¶¦ç­‰äºEBTå‡ç¨', () => {
                            const year1 = incomeData[0];
                            test.assertAlmostEqual(year1.netProfit, year1.ebt - year1.tax, 
                                0.01, 'å‡€åˆ©æ¶¦è®¡ç®—');
                        });
                        
                        test.it('ç¨é¢ä¸ºéè´Ÿæ•°', () => {
                            incomeData.forEach((data, i) => {
                                test.assertTrue(data.tax >= 0, `ç¬¬${i + 1}å¹´ç¨é¢åº”éè´Ÿ`);
                            });
                        });
                        
                        test.it('äºæŸå¹´ä»½ç¨é¢ä¸ºé›¶', () => {
                            incomeData.forEach((data, i) => {
                                if (data.ebt < 0) {
                                    test.assertEqual(data.tax, 0, `ç¬¬${i + 1}å¹´äºæŸæ—¶ç¨é¢åº”ä¸ºé›¶`);
                                }
                            });
                        });
                    });
                    
                    // ========== 8. ç°é‡‘æµè®¡ç®—æµ‹è¯• ==========
                    test.describe('8. ç°é‡‘æµè®¡ç®—æµ‹è¯•', () => {
                        const params = getTestParameters();
                        const capex = calculateCapex(params);
                        const opexData = calculateOpex(params, capex);
                        const spotPrices = [];
                        for (let i = 0; i < params.operation_years; i++) {
                            spotPrices.push(35000 * Math.pow(1.015, i));
                        }
                        const revenueData = calculateRevenueWithPrices(params, spotPrices);
                        const depreciation = calculateDepreciation(params, capex);
                        const loanData = calculateLoan(params, capex);
                        const incomeData = calculateIncomeStatement(params, revenueData, opexData, depreciation, loanData);
                        const cashFlowData = calculateCashFlow(params, capex, incomeData, depreciation, loanData);
                        
                        test.it('ç°é‡‘æµåŒ…å«å»ºè®¾æœŸ', () => {
                            test.assertEqual(cashFlowData[0].year, 0, 'ç¬¬ä¸€æ¡åº”ä¸ºå»ºè®¾æœŸ');
                        });
                        
                        test.it('å»ºè®¾æœŸæŠ•èµ„ç°é‡‘æµä¸ºè´Ÿ', () => {
                            test.assertLessThan(cashFlowData[0].investingCashFlow, 0, 
                                'å»ºè®¾æœŸæŠ•èµ„ç°é‡‘æµåº”ä¸ºè´Ÿ');
                        });
                        
                        test.it('å»ºè®¾æœŸè‚¡æƒå’Œè´·æ¬¾æµå…¥æ­£ç¡®', () => {
                            const equity = capex.dynamic_total * params.equity_ratio;
                            const loan = capex.dynamic_total * (1 - params.equity_ratio);
                            test.assertAlmostEqual(cashFlowData[0].equityInflow, equity, 1, 'è‚¡æƒæµå…¥');
                            test.assertAlmostEqual(cashFlowData[0].loanInflow, loan, 1, 'è´·æ¬¾æµå…¥');
                        });
                        
                        test.it('è¿è¥æœŸç»è¥ç°é‡‘æµç­‰äºå‡€åˆ©æ¶¦åŠ æŠ˜æ—§', () => {
                            const year1 = cashFlowData[1];
                            test.assertAlmostEqual(year1.operatingCashFlow, 
                                year1.netProfit + year1.depreciation, 0.01, 'ç»è¥ç°é‡‘æµ');
                        });
                        
                        test.it('å…¨æŠ•èµ„ç°é‡‘æµç¬¬0å¹´ä¸ºè´ŸæŠ•èµ„', () => {
                            test.assertAlmostEqual(cashFlowData[0].projectCashFlow, 
                                -capex.dynamic_total, 1, 'å…¨æŠ•èµ„ç°é‡‘æµç¬¬0å¹´');
                        });
                        
                        test.it('èµ„æœ¬é‡‘ç°é‡‘æµç¬¬0å¹´ä¸ºè´Ÿæƒç›Š', () => {
                            const equity = capex.dynamic_total * params.equity_ratio;
                            test.assertAlmostEqual(cashFlowData[0].equityCashFlow, -equity, 1, 
                                'èµ„æœ¬é‡‘ç°é‡‘æµç¬¬0å¹´');
                        });

                        test.it('æœ«å¹´æŠ•èµ„ç°é‡‘æµä»…åŒ…å«æ®‹å€¼å›æ”¶', () => {
                            const intangibleAssets = (capex.dev_cost || 0) + (capex.land || 0);
                            const fixedAssetOriginal = capex.dynamic_total - intangibleAssets;
                            const expectedSalvage = fixedAssetOriginal * params.salvage_rate;
                            const lastYear = cashFlowData[params.operation_years];
                            test.assertAlmostEqual(lastYear.investingCashFlow, expectedSalvage, 0.01, 'æœ«å¹´æŠ•èµ„ç°é‡‘æµ');
                        });
                    });
                    
                    // ========== 9. IRR/NPVè®¡ç®—æµ‹è¯• ==========
                    test.describe('9. IRR/NPVè®¡ç®—æµ‹è¯•', () => {
                        test.it('IRRè®¡ç®—-ç®€å•æ¡ˆä¾‹éªŒè¯', () => {
                            // æµ‹è¯•æ¡ˆä¾‹: æŠ•èµ„100ï¼Œæ¯å¹´å›æ”¶50ï¼Œå…±3å¹´
                            const cashFlows = [-100, 50, 50, 50];
                            const irr = calculateIRR(cashFlows);
                            // ç†è®ºä¸Šçº¦23.38%
                            test.assertInRange(irr, 20, 26, 'IRRåº”åœ¨åˆç†èŒƒå›´');
                        });
                        
                        test.it('IRRè®¡ç®—-å…¨æ­£ç°é‡‘æµåº”è¿”å›é«˜IRR', () => {
                            const cashFlows = [-100, 200];
                            const irr = calculateIRR(cashFlows);
                            test.assertGreaterThan(irr, 50, 'ç¿»å€æŠ•èµ„IRRåº”å¤§äº50%');
                        });
                        
                        test.it('NPVè®¡ç®—-é›¶æŠ˜ç°ç‡ç­‰äºç°é‡‘æµæ€»å’Œ', () => {
                            const cashFlows = [-100, 50, 50, 50];
                            const npv = calculateNPV(cashFlows, 0);
                            test.assertAlmostEqual(npv, 50, 0.01, 'é›¶æŠ˜ç°ç‡NPV');
                        });
                        
                        test.it('NPVè®¡ç®—-æ­£æŠ˜ç°ç‡ç»“æœå°äºé›¶æŠ˜ç°ç‡', () => {
                            const cashFlows = [-100, 50, 50, 50];
                            const npv0 = calculateNPV(cashFlows, 0);
                            const npv8 = calculateNPV(cashFlows, 0.08);
                            test.assertGreaterThan(npv0, npv8, 'æ­£æŠ˜ç°ç‡NPVåº”æ›´å°');
                        });
                        
                        test.it('é™æ€å›æ”¶æœŸè®¡ç®—æ­£ç¡®', () => {
                            const cashFlows = [-100, 40, 40, 40, 40];
                            const payback = calculateStaticPayback(cashFlows);
                            test.assertInRange(payback, 2, 3, 'å›æ”¶æœŸåº”åœ¨2-3å¹´');
                        });
                        
                        test.it('åŠ¨æ€å›æ”¶æœŸå¤§äºé™æ€å›æ”¶æœŸ', () => {
                            const cashFlows = [-100, 40, 40, 40, 40];
                            const staticPB = calculateStaticPayback(cashFlows);
                            const dynamicPB = calculateDynamicPayback(cashFlows, 0.08);
                            test.assertGreaterThan(dynamicPB, staticPB, 'åŠ¨æ€å›æ”¶æœŸåº”å¤§äºé™æ€å›æ”¶æœŸ');
                        });
                    });
                    
                    // ========== 10. è´¢åŠ¡æŒ‡æ ‡æµ‹è¯• ==========
                    test.describe('10. è´¢åŠ¡æŒ‡æ ‡ç»¼åˆæµ‹è¯•', () => {
                        const params = getTestParameters();
                        const capex = calculateCapex(params);
                        const opexData = calculateOpex(params, capex);
                        const spotPrices = [];
                        for (let i = 0; i < params.operation_years; i++) {
                            spotPrices.push(35000 * Math.pow(1.015, i));
                        }
                        const revenueData = calculateRevenueWithPrices(params, spotPrices);
                        const depreciation = calculateDepreciation(params, capex);
                        const loanData = calculateLoan(params, capex);
                        const incomeData = calculateIncomeStatement(params, revenueData, opexData, depreciation, loanData);
                        const cashFlowData = calculateCashFlow(params, capex, incomeData, depreciation, loanData);
                        const balanceData = calculateBalanceSheet(params, capex, incomeData, depreciation, loanData, cashFlowData);
                        const indicators = calculateIndicators(params, capex, revenueData, incomeData, cashFlowData, balanceData, loanData);
                        
                        test.it('é™æ€æŠ•èµ„ç­‰äºCAPEXæ€»é¢', () => {
                            test.assertAlmostEqual(indicators.static_investment, capex.total, 0.1, 'é™æ€æŠ•èµ„');
                        });
                        
                        test.it('åŠ¨æ€æŠ•èµ„ç­‰äºå«åˆ©æ¯CAPEX', () => {
                            test.assertAlmostEqual(indicators.dynamic_investment, capex.dynamic_total, 0.1, 'åŠ¨æ€æŠ•èµ„');
                        });
                        
                        test.it('é¡¹ç›®IRRä¸ºæœ‰æ•ˆæ•°å€¼', () => {
                            test.assertIsNumber(indicators.project_irr, 'é¡¹ç›®IRRåº”ä¸ºæ•°å­—');
                        });
                        
                        test.it('æƒç›ŠIRRå¤§äºé¡¹ç›®IRRï¼ˆæ æ†æ•ˆåº”ï¼‰', () => {
                            if (!isNaN(indicators.equity_irr) && !isNaN(indicators.project_irr)) {
                                test.assertGreaterThan(indicators.equity_irr, indicators.project_irr, 
                                    'æƒç›ŠIRRåº”å¤§äºé¡¹ç›®IRRï¼ˆæ­£æ æ†ï¼‰');
                            }
                        });
                        
                        test.it('å›æ”¶æœŸåœ¨åˆç†èŒƒå›´å†… (1-20å¹´)', () => {
                            test.assertInRange(indicators.static_payback, 1, 20, 'é™æ€å›æ”¶æœŸ');
                        });
                        
                        test.it('ROIä¸ºæ­£å€¼', () => {
                            test.assertGreaterThan(indicators.roi, 0, 'ROIåº”ä¸ºæ­£');
                        });
                        
                        test.it('DSCRå¤§äº1ï¼ˆå¿å€ºèƒ½åŠ›è¶³å¤Ÿï¼‰', () => {
                            test.assertGreaterThan(indicators.dscr, 1, 'DSCRåº”å¤§äº1');
                        });
                        
                        test.it('æ€»æ”¶å…¥ç­‰äºå„å¹´æ”¶å…¥ä¹‹å’Œ', () => {
                            const sum = revenueData.reduce((a, b) => a + b.totalRevenue, 0);
                            test.assertAlmostEqual(indicators.total_revenue, sum, 0.1, 'æ€»æ”¶å…¥');
                        });
                    });
                    
                    // ========== 11. è¾¹ç•Œæ¡ä»¶æµ‹è¯• ==========
                    test.describe('11. è¾¹ç•Œæ¡ä»¶æµ‹è¯•', () => {
                        test.it('é›¶åŠŸç‡æƒ…å†µå¤„ç†', () => {
                            const params = getTestParameters();
                            params.power_mw = 0;
                            const capex = calculateCapex(params);
                            test.assertIsNumber(capex.total, 'é›¶åŠŸç‡CAPEXåº”å¯è®¡ç®—');
                        });
                        
                        test.it('100%è‚¡æƒèèµ„æƒ…å†µ', () => {
                            const params = getTestParameters();
                            params.equity_ratio = 1.0;
                            const capex = calculateCapex(params);
                            const loanData = calculateLoan(params, capex);
                            test.assertEqual(loanData[0].beginBalance, 0, '100%è‚¡æƒæ—¶è´·æ¬¾åº”ä¸ºé›¶');
                        });
                        
                        test.it('é›¶Tollingæ¯”ä¾‹æƒ…å†µ', () => {
                            const params = getTestParameters();
                            params.tolling_ratio = 0;
                            const spotPrices = Array(20).fill(35000);
                            const revenueData = calculateRevenueWithPrices(params, spotPrices);
                            test.assertEqual(revenueData[0].tollingRevenue, 0, 'é›¶Tollingæ¯”ä¾‹æ—¶Tollingæ”¶å…¥ä¸ºé›¶');
                        });
                        
                        test.it('é›¶è¡°å‡ç‡æƒ…å†µ', () => {
                            const params = getTestParameters();
                            params.degradation_rate = 0;
                            const spotPrices = Array(20).fill(35000);
                            const revenueData = calculateRevenueWithPrices(params, spotPrices);
                            test.assertEqual(revenueData[0].capacityFactor, revenueData[19].capacityFactor, 
                                'é›¶è¡°å‡æ—¶å®¹é‡å› å­åº”ä¸å˜');
                        });
                        
                        test.it('æœ€å°è¿è¥å¹´é™ï¼ˆ1å¹´ï¼‰', () => {
                            const params = getTestParameters();
                            params.operation_years = 1;
                            const capex = calculateCapex(params);
                            const opexData = calculateOpex(params, capex);
                            test.assertEqual(opexData.length, 1, '1å¹´è¿è¥åº”åªæœ‰1å¹´OPEX');
                        });
                        
                        test.it('é›¶æ®‹å€¼ç‡æƒ…å†µ', () => {
                            const params = getTestParameters();
                            params.salvage_rate = 0;
                            const capex = calculateCapex(params);
                            const depreciation = calculateDepreciation(params, capex);
                            const totalDep = depreciation.slice(0, params.depreciation_years)
                                .reduce((a, b) => a + b.depreciation, 0);
                            test.assertAlmostEqual(totalDep, capex.total, 1, 'é›¶æ®‹å€¼æ—¶æŠ˜æ—§æ€»é¢ç­‰äºåŸå€¼');
                        });
                    });
                    
                    // ========== 12. æ•°æ®ä¸€è‡´æ€§æµ‹è¯• ==========
                    test.describe('12. æ•°æ®ä¸€è‡´æ€§æµ‹è¯•', () => {
                        const params = getTestParameters();
                        const capex = calculateCapex(params);
                        const opexData = calculateOpex(params, capex);
                        const spotPrices = [];
                        for (let i = 0; i < params.operation_years; i++) {
                            spotPrices.push(35000 * Math.pow(1.015, i));
                        }
                        const revenueData = calculateRevenueWithPrices(params, spotPrices);
                        const depreciation = calculateDepreciation(params, capex);
                        const loanData = calculateLoan(params, capex);
                        const incomeData = calculateIncomeStatement(params, revenueData, opexData, depreciation, loanData);
                        const cashFlowData = calculateCashFlow(params, capex, incomeData, depreciation, loanData);
                        const balanceData = calculateBalanceSheet(params, capex, incomeData, depreciation, loanData, cashFlowData);
                        
                        test.it('èµ„äº§è´Ÿå€ºè¡¨å¹³è¡¡', () => {
                            balanceData.forEach((data, i) => {
                                const diff = Math.abs(data.totalAssets - data.totalLiabilitiesAndEquity);
                                test.assertLessThan(diff, 1, `ç¬¬${i}å¹´èµ„äº§è´Ÿå€ºåº”å¹³è¡¡`);
                            });
                        });
                        
                        test.it('åˆ©æ¶¦è¡¨æ”¶å…¥ä¸æ”¶å…¥è¡¨ä¸€è‡´', () => {
                            incomeData.forEach((income, i) => {
                                test.assertAlmostEqual(income.revenue, revenueData[i].totalRevenue, 
                                    0.01, `ç¬¬${i + 1}å¹´æ”¶å…¥ä¸€è‡´æ€§`);
                            });
                        });
                        
                        test.it('åˆ©æ¶¦è¡¨æˆæœ¬ä¸OPEXä¸€è‡´', () => {
                            incomeData.forEach((income, i) => {
                                test.assertAlmostEqual(income.opex, opexData[i].total, 
                                    0.01, `ç¬¬${i + 1}å¹´æˆæœ¬ä¸€è‡´æ€§`);
                            });
                        });
                        
                        test.it('åˆ©æ¶¦è¡¨æŠ˜æ—§ä¸æŠ˜æ—§è¡¨ä¸€è‡´', () => {
                            incomeData.forEach((income, i) => {
                                test.assertAlmostEqual(income.depreciation, depreciation[i].total, 
                                    0.01, `ç¬¬${i + 1}å¹´æŠ˜æ—§ä¸€è‡´æ€§`);
                            });
                        });
                        
                        test.it('åˆ©æ¶¦è¡¨åˆ©æ¯ä¸è´·æ¬¾è¡¨ä¸€è‡´', () => {
                            incomeData.forEach((income, i) => {
                                test.assertAlmostEqual(income.interest, loanData[i].interest, 
                                    0.01, `ç¬¬${i + 1}å¹´åˆ©æ¯ä¸€è‡´æ€§`);
                            });
                        });
                        
                        test.it('ç°é‡‘æµå‡€åˆ©æ¶¦ä¸åˆ©æ¶¦è¡¨ä¸€è‡´', () => {
                            for (let i = 1; i <= params.operation_years; i++) {
                                test.assertAlmostEqual(cashFlowData[i].netProfit, incomeData[i - 1].netProfit, 
                                    0.01, `ç¬¬${i}å¹´å‡€åˆ©æ¶¦ä¸€è‡´æ€§`);
                            }
                        });
                        
                        test.it('ç´¯è®¡è¿˜æœ¬é‡‘é¢ç­‰äºè´·æ¬¾æ€»é¢', () => {
                            const totalPrincipal = loanData.reduce((a, b) => a + b.principal, 0);
                            const loanAmount = capex.dynamic_total * (1 - params.equity_ratio);
                            test.assertAlmostEqual(totalPrincipal, loanAmount, 1, 'ç´¯è®¡è¿˜æœ¬');
                        });
                    });
                    
                    // ========== 13. æ•æ„Ÿæ€§åˆ†æå‚æ•°æµ‹è¯• ==========
                    test.describe('13. æ•æ„Ÿæ€§åˆ†æåŠŸèƒ½æµ‹è¯•', () => {
                        const params = getTestParameters();
                        
                        test.it('CAPEXå˜åŒ–å½±å“é¡¹ç›®IRR', () => {
                            const params1 = JSON.parse(JSON.stringify(params));
                            const params2 = JSON.parse(JSON.stringify(params));
                            applyVariableChange(params2, 'capex', 0.1); // å¢åŠ 10%
                            
                            const irr1 = calculateTargetIndicator(params1, 'project_irr');
                            const irr2 = calculateTargetIndicator(params2, 'project_irr');
                            
                            test.assertGreaterThan(irr1, irr2, 'CAPEXå¢åŠ åº”é™ä½IRR');
                        });
                        
                        test.it('Tollingä»·æ ¼å˜åŒ–å½±å“é¡¹ç›®IRR', () => {
                            const params1 = JSON.parse(JSON.stringify(params));
                            const params2 = JSON.parse(JSON.stringify(params));
                            applyVariableChange(params2, 'tolling_price', 0.1); // å¢åŠ 10%
                            
                            const irr1 = calculateTargetIndicator(params1, 'project_irr');
                            const irr2 = calculateTargetIndicator(params2, 'project_irr');
                            
                            test.assertLessThan(irr1, irr2, 'Tollingä»·æ ¼å¢åŠ åº”æé«˜IRR');
                        });
                        
                        test.it('OPEXå˜åŒ–å½±å“é¡¹ç›®IRR', () => {
                            const params1 = JSON.parse(JSON.stringify(params));
                            const params2 = JSON.parse(JSON.stringify(params));
                            applyVariableChange(params2, 'opex', 0.2); // å¢åŠ 20%
                            
                            const irr1 = calculateTargetIndicator(params1, 'project_irr');
                            const irr2 = calculateTargetIndicator(params2, 'project_irr');
                            
                            test.assertGreaterThan(irr1, irr2, 'OPEXå¢åŠ åº”é™ä½IRR');
                        });
                        
                        test.it('è´·æ¬¾åˆ©ç‡å˜åŒ–å½±å“æƒç›ŠIRR', () => {
                            const params1 = JSON.parse(JSON.stringify(params));
                            const params2 = JSON.parse(JSON.stringify(params));
                            applyVariableChange(params2, 'loan_rate', 0.2); // å¢åŠ 20%
                            
                            const irr1 = calculateTargetIndicator(params1, 'equity_irr');
                            const irr2 = calculateTargetIndicator(params2, 'equity_irr');
                            
                            test.assertGreaterThan(irr1, irr2, 'è´·æ¬¾åˆ©ç‡å¢åŠ åº”é™ä½æƒç›ŠIRR');
                        });
                    });
                    
                } catch (e) {
                    console.error('æµ‹è¯•æ‰§è¡Œé”™è¯¯:', e);
                }
                
                // æ¸²æŸ“ç»“æœ
                test.renderResults();
                loading.style.display = 'none';
                btn.disabled = false;
                
            }, 100);
        }
        
        // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>
